---
title: "Sql High Performance"
date: 2021-08-13T10:13:21+08:00
draft: false
---

> 数据库就是用于执行查询的，提高查询速度是调优的最终目标。数据库的性能取决于许多因素，主要是查询、schema、配置项和硬件。

● explain计划

可以使用EXPLAIN命令来验证MySQL的执行计划。从MySQL 5.7.2开始，可以使用EXPLAIN命令来检查当前在其他会话中执行的查询。执行EXPLAIN FORMAT=JSON命令，将得到详细信息。

```sql
explain select name from dept

-- 使用EXPLAIN JSON
explain format = json select name from dept
```

● 基准查询和服务器

可以使用mysqlslap工具（就在MySQL客户端的安装包中），它模拟MySQL服务器的客户端负载，并报告每个阶段所耗费的时间，就像多个客户端正在访该问服务器一样。

● 添加索引

InnoDB有两大类索引： 

聚集索引(clustered index) #主键索引, 
普通索引(secondary index) #第二索引

关于主键的选择，有如下一些小技巧：

 -  它应该是UNIQUE（唯一）和NOT NULL（非空）的。
 -  选择最小的可能键，因为所有的二级索引都会存储主键。所以如果主键很大，整个索引也会占用更多的空间。
 -  选择一个单调递增的值。物理行是根据主键进行排序的。所以，如果你选择一个随机键，需要做多次行重排，这会导致性能下降。AUTO_INCREMENT非常适合主键。
 -  最好选择一个主键。如果找不到任何主键，请添加一个AUTO_INCREMENT列。如果你不选择任何内容，InnoDB会在内部生成一个带有6字节行ID的隐藏聚簇索引。

● 不可见索引

如果你想删除未使用的索引，可以不立即删除，而是先将其标记为不可见，然后监控应用程序的行为，稍后再删除它。之后，如果你还需要该索引，则可以将其标记为可见，这与先删除索引再重新添加相比会快很多。

● 降序索引

● 使用pt-query-digest分析慢查询
pt-query-digest是Percona工具包的一部分，用于对查询进行分析。可以通过以下任何方式收集查询：

 - 慢查询日志
 - 通用查询日志
 - 进程列表
 - 二进制日志
 - TCP转储

● 优化数据类型

● 删除重复和冗余索引

你可以在一列上定义多个索引。如果不小心的话，你可能会重复定义相同的索引（相同的列、相同的列顺序或相同的键顺序），这被称为重复索引。如果只有部分索引（最左边的列）是重复的，则称为冗余索引。重复索引没有什么用处。在某些情况下，冗余索引可能很有用（本节末尾的提示中提到了一个用例），但是这两者都会减慢插入的速度。因此，找出并移除这两种索引非常重要

● 检查索引使用情况

● 控制查询优化器

● 使用索引提示（hint）

● 使用生成的列为JSON建立索引

● 使用资源组

● 使用performance_schema

● 使用sys schema