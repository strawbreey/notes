<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Mysql Slow Query - My New Hugo Site</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="olOwOlo" /><meta name="description" content="开启 MySQL 慢查询日志 MySQL 提供了慢查询日志, 这个日志会记录所有执行时间超过 long_query_time（默认是 10s）的 SQL 及相关的信息。
mysql&amp;gt; show variables like &amp;#39;long_query_time&amp;#39;; &#43;-----------------&#43;-----------&#43; | Variable_name | Value | &#43;-----------------&#43;-----------&#43; | long_query_time | 10.000000 | &#43;-----------------&#43;-----------&#43; 1 row in set mysql&amp;gt; show variables like &amp;#39;slow_query%&amp;#39;; &#43;---------------------&#43;--------------------------------------&#43; | Variable_name | Value | &#43;---------------------&#43;--------------------------------------&#43; | slow_query_log | OFF | | slow_query_log_file | /var/log/mysql/log-slow-queries.log | &#43;---------------------&#43;--------------------------------------&#43; 2 rows in set 在这里，slow_query_log 指的是慢查询日志是否开启，slow_query_log_file 指明了日志所在的位置。
在 MySQL 的配置文件 my.cnf 的 [mysqld] 项下可以配置慢查询日志开启，一般来讲如下配置即可：
[mysqld]slow_query_log=1slow_query_log_file=/var/log/mysql/log-slow-queries." />






<meta name="generator" content="Hugo 0.86.0-DEV with theme even" />


<link rel="canonical" href="https://example.org/posts/mysql/sql-slow-query/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">



<meta property="og:title" content="Mysql Slow Query" />
<meta property="og:description" content="开启 MySQL 慢查询日志 MySQL 提供了慢查询日志, 这个日志会记录所有执行时间超过 long_query_time（默认是 10s）的 SQL 及相关的信息。
mysql&gt; show variables like &#39;long_query_time&#39;; &#43;-----------------&#43;-----------&#43; | Variable_name | Value | &#43;-----------------&#43;-----------&#43; | long_query_time | 10.000000 | &#43;-----------------&#43;-----------&#43; 1 row in set mysql&gt; show variables like &#39;slow_query%&#39;; &#43;---------------------&#43;--------------------------------------&#43; | Variable_name | Value | &#43;---------------------&#43;--------------------------------------&#43; | slow_query_log | OFF | | slow_query_log_file | /var/log/mysql/log-slow-queries.log | &#43;---------------------&#43;--------------------------------------&#43; 2 rows in set 在这里，slow_query_log 指的是慢查询日志是否开启，slow_query_log_file 指明了日志所在的位置。
在 MySQL 的配置文件 my.cnf 的 [mysqld] 项下可以配置慢查询日志开启，一般来讲如下配置即可：
[mysqld]slow_query_log=1slow_query_log_file=/var/log/mysql/log-slow-queries." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.org/posts/mysql/sql-slow-query/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-12T11:23:12+08:00" />
<meta property="article:modified_time" content="2021-08-12T11:23:12+08:00" />

<meta itemprop="name" content="Mysql Slow Query">
<meta itemprop="description" content="开启 MySQL 慢查询日志 MySQL 提供了慢查询日志, 这个日志会记录所有执行时间超过 long_query_time（默认是 10s）的 SQL 及相关的信息。
mysql&gt; show variables like &#39;long_query_time&#39;; &#43;-----------------&#43;-----------&#43; | Variable_name | Value | &#43;-----------------&#43;-----------&#43; | long_query_time | 10.000000 | &#43;-----------------&#43;-----------&#43; 1 row in set mysql&gt; show variables like &#39;slow_query%&#39;; &#43;---------------------&#43;--------------------------------------&#43; | Variable_name | Value | &#43;---------------------&#43;--------------------------------------&#43; | slow_query_log | OFF | | slow_query_log_file | /var/log/mysql/log-slow-queries.log | &#43;---------------------&#43;--------------------------------------&#43; 2 rows in set 在这里，slow_query_log 指的是慢查询日志是否开启，slow_query_log_file 指明了日志所在的位置。
在 MySQL 的配置文件 my.cnf 的 [mysqld] 项下可以配置慢查询日志开启，一般来讲如下配置即可：
[mysqld]slow_query_log=1slow_query_log_file=/var/log/mysql/log-slow-queries."><meta itemprop="datePublished" content="2021-08-12T11:23:12+08:00" />
<meta itemprop="dateModified" content="2021-08-12T11:23:12+08:00" />
<meta itemprop="wordCount" content="228">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mysql Slow Query"/>
<meta name="twitter:description" content="开启 MySQL 慢查询日志 MySQL 提供了慢查询日志, 这个日志会记录所有执行时间超过 long_query_time（默认是 10s）的 SQL 及相关的信息。
mysql&gt; show variables like &#39;long_query_time&#39;; &#43;-----------------&#43;-----------&#43; | Variable_name | Value | &#43;-----------------&#43;-----------&#43; | long_query_time | 10.000000 | &#43;-----------------&#43;-----------&#43; 1 row in set mysql&gt; show variables like &#39;slow_query%&#39;; &#43;---------------------&#43;--------------------------------------&#43; | Variable_name | Value | &#43;---------------------&#43;--------------------------------------&#43; | slow_query_log | OFF | | slow_query_log_file | /var/log/mysql/log-slow-queries.log | &#43;---------------------&#43;--------------------------------------&#43; 2 rows in set 在这里，slow_query_log 指的是慢查询日志是否开启，slow_query_log_file 指明了日志所在的位置。
在 MySQL 的配置文件 my.cnf 的 [mysqld] 项下可以配置慢查询日志开启，一般来讲如下配置即可：
[mysqld]slow_query_log=1slow_query_log_file=/var/log/mysql/log-slow-queries."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">My New Hugo Site</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">My New Hugo Site</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  <div class="post-content">
    <h3 id="开启-mysql-慢查询日志">开启 MySQL 慢查询日志</h3>
<p>MySQL 提供了慢查询日志, 这个日志会记录所有执行时间超过 long_query_time（默认是 10s）的 SQL 及相关的信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysql&gt; show variables like <span style="color:#e6db74">&#39;long_query_time&#39;</span>;
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+
<span style="color:#ae81ff">1</span> row in set

mysql&gt; show variables like <span style="color:#e6db74">&#39;slow_query%&#39;</span>;
+---------------------+--------------------------------------+
| Variable_name       | Value                                |
+---------------------+--------------------------------------+
| slow_query_log      | OFF                                  |
| slow_query_log_file | /var/log/mysql/log-slow-queries.log  |
+---------------------+--------------------------------------+
<span style="color:#ae81ff">2</span> rows in set
</code></pre></div><p>在这里，slow_query_log 指的是慢查询日志是否开启，slow_query_log_file 指明了日志所在的位置。</p>
<p>在 MySQL 的配置文件 my.cnf 的 [mysqld] 项下可以配置慢查询日志开启，一般来讲如下配置即可：</p>
<pre><code class="language-conf" data-lang="conf">[mysqld]
slow_query_log=1
slow_query_log_file=/var/log/mysql/log-slow-queries.log
long_query_time=2
</code></pre><p>需要注意的是，应该赋予 slow_query_log_file 指向的目录 mysql 用户的写入权限：chown mysql.mysql -R /var/log/mysql，一般用默认的目录就好。详细的文档可以看这里：6.4.5 The Slow Query Log。</p>
<p>之后需重载 MySQL 配置生效：/etc/init.d/mysql reload。</p>
<h3 id="分析慢查询日志">分析慢查询日志</h3>
<p>在开启了 MySQL 慢查询日志一段时间之后，日志中就会把所有超过 long_query_time 的 SQL 记录下来。另一个有用的相关 MySQL 命令是 mysqldumpslow：由于慢查询日志可能很大或者很难分析，使用它可以获得 MySQL 对慢查询日志的一个总结报告，直接获得我们想要的统计分析后的结果。详细的文档可以看这里：5.6.8 mysqldumpslow — Summarize Slow Query Log Files。</p>
<p>当然，你也可以打开日志文件自己来查询、分析。</p>
<h3 id="优化-sql">优化 SQL</h3>
<p>在得知哪些 SQL 是慢查询之后，我们就可以定位到具体的业务接口并针对性的进行优化了。</p>
<p>首先，你要看是否能在不改变现有业务逻辑的前提下改进查询的速度。一个典型的场景是，你需要查询数据库中是否存在符合某个条件的记录，返回一个布尔值来表示有或者没有，一般用于通知提醒。如果程序员在撰写接口时没把性能放在心上，那么他就有可能写出 <code>SELECT count(*) FROM tbl_xxx WHERE XXXX</code> 这样的查询，当数据量一大时（而且索引不恰当或没有索引）这个查询会相当之慢，但如果改成 <code>SELECT id FROM tbl_xxx WHERE XXXX LIMIT 1</code> 这样来查询，对速度的提升则是巨大的。这个例子并不是我凭空捏造的，最近在实际项目中我就看到了跟这个例子一模一样的场景。</p>
<p>能够找到上述的通过改变查询方式而又不改变业务逻辑的慢查询是幸运的，因为这些场景往往意味着只需重写 SQL 语句就能带来显著的性能提升，而且稍有经验的程序员在一开始就不会写出能够明显改良的查询语句。在绝大多数情况下，SQL 足够复杂而且难以做任何有价值的改动，这时就需要通过优化索引来提升效率了。</p>
<p>如何更好的创建数据库索引绝对是一门技术活，我也并不觉得简简单单就能厘得很清楚，很多时候还是得具体 SQL 具体分析，甚至多条 SQL 一起来分析。可以先读一读这篇美团点评技术团队的文章：MySQL 索引原理及慢查询优化，更深入的了解则可以阅读《高性能 MySQL》一书。引用一下美团点评技术团队文章中提到的几个原则：</p>
<ul>
<li>
<p>最左前缀匹配原则，非常重要的原则，mysql 会一直向右匹配直到遇到范围查询 (&gt;、&lt;、between、like) 就停止匹配，比如 a = 1 and b = 2 and c &gt; 3 and d = 4 如果建立 (a,b,c,d) 顺序的索引，d 是用不到索引的，如果建立 (a,b,d,c) 的索引则都可以用到，a,b,d 的顺序可以任意调整；</p>
</li>
<li>
<p>= 和 in 可以乱序，比如 a = 1 and b = 2 and c = 3 建立 (a,b,c) 索引可以任意顺序，mysql 的查询优化器会帮你优化成索引可以识别的形式；</p>
</li>
<li>
<p>尽量选择区分度高的列作为索引, 区分度的公式是 count(distinct col)/count(*)，表示字段不重复的比例，比例越大我们扫描的记录数越少，唯一键的区分度是 1，而一些状态、性别字段可能在大数据面前区分度就是 0，那可能有人会问，这个比例有什么经验值吗？使用场景不同，这个值也很难确定，一般需要 join 的字段我们都要求是 0.1 以上，即平均 1 条扫描 10 条记录；</p>
</li>
<li>
<p>索引列不能参与计算，保持列 “干净”，比如 from_unixtime(create_time) = ’2014-05-29’就不能使用到索引，原因很简单，b + 树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成 create_time = unix_timestamp(’2014-05-29’);</p>
</li>
<li>
<p>尽量的扩展索引，不要新建索引。比如表中已经有 a 的索引，现在要加 (a,b) 的索引，那么只需要修改原来的索引即可。</p>
</li>
</ul>
<p>常用的套路是在定位到慢查询语句之后，使用 EXPLAIN + SQL 来了解 MySQL 在执行这条数据时的一些细节，比如是否进行了优化、是否使用了索引等等。基于 Explain 的返回结果我们就可以根据 MySQL 的执行细节进一步分析是否应该优化搜索、怎样优化索引。</p>

  </div>
</article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://example.org/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
     - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>olOwOlo</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
