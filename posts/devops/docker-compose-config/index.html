<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Docker Compose Config - My New Hugo Site</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="olOwOlo" /><meta name="description" content="在项目中，往往需要在 docker-compose.yml 文件中使用环境变量来控制不同的条件和使用场景。本文集中介绍 docker compose 引用环境变量的方式。
Compose CLI 与环境变量 Compose CLI(compose command-line 即 docker-compose 程序)能够识别名称为 COMPOSE_PROJECT_NAME 和 COMPOSE_FILE 等环境变量(具体支持的环境变量请参考这里)。比如我们可以通过这两个环境变量为 docker-compose 指定 project 的名称和配置文件：
export COMPOSE_PROJECT_NAME=TestVar export COMPOSE_FILE=~/projects/composecounter/docker-compose.yml 然后启动应用，显示的 project 名称都是我们在环境变量中指定的：
如果设置了环境变量的同时又指定了命令行选项，那么会应用命令行选项的设置：
docker-compose -p nickproject up -d 在 compose file 中引用环境变量 我们还可以在 compose file 中直接引用环境变量，比如下面的 demo：
version: &amp;#39;3&amp;#39; services: web: image: ${IMAGETAG} ports: - &amp;#34;5000:5000&amp;#34; redis: image: &amp;#34;redis:alpine&amp;#34; 我们通过环境变量 ${IMAGETAG} 指定了 web 的镜像，下面通过 export 的方式来为 compose 配置文件中的环境变量传值：
注意，如果对应的环境变量没有被设置，那么 compose 就会把它替换为一个空字符串：
碰到这种情况，我们可以在 compose 的配置文件中为该变量设置一个默认值：" />






<meta name="generator" content="Hugo 0.86.0-DEV with theme even" />


<link rel="canonical" href="https://example.org/posts/devops/docker-compose-config/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">



<meta property="og:title" content="Docker Compose Config" />
<meta property="og:description" content="在项目中，往往需要在 docker-compose.yml 文件中使用环境变量来控制不同的条件和使用场景。本文集中介绍 docker compose 引用环境变量的方式。
Compose CLI 与环境变量 Compose CLI(compose command-line 即 docker-compose 程序)能够识别名称为 COMPOSE_PROJECT_NAME 和 COMPOSE_FILE 等环境变量(具体支持的环境变量请参考这里)。比如我们可以通过这两个环境变量为 docker-compose 指定 project 的名称和配置文件：
export COMPOSE_PROJECT_NAME=TestVar export COMPOSE_FILE=~/projects/composecounter/docker-compose.yml 然后启动应用，显示的 project 名称都是我们在环境变量中指定的：
如果设置了环境变量的同时又指定了命令行选项，那么会应用命令行选项的设置：
docker-compose -p nickproject up -d 在 compose file 中引用环境变量 我们还可以在 compose file 中直接引用环境变量，比如下面的 demo：
version: &#39;3&#39; services: web: image: ${IMAGETAG} ports: - &#34;5000:5000&#34; redis: image: &#34;redis:alpine&#34; 我们通过环境变量 ${IMAGETAG} 指定了 web 的镜像，下面通过 export 的方式来为 compose 配置文件中的环境变量传值：
注意，如果对应的环境变量没有被设置，那么 compose 就会把它替换为一个空字符串：
碰到这种情况，我们可以在 compose 的配置文件中为该变量设置一个默认值：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.org/posts/devops/docker-compose-config/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-23T17:57:39+08:00" />
<meta property="article:modified_time" content="2020-12-23T17:57:39+08:00" />

<meta itemprop="name" content="Docker Compose Config">
<meta itemprop="description" content="在项目中，往往需要在 docker-compose.yml 文件中使用环境变量来控制不同的条件和使用场景。本文集中介绍 docker compose 引用环境变量的方式。
Compose CLI 与环境变量 Compose CLI(compose command-line 即 docker-compose 程序)能够识别名称为 COMPOSE_PROJECT_NAME 和 COMPOSE_FILE 等环境变量(具体支持的环境变量请参考这里)。比如我们可以通过这两个环境变量为 docker-compose 指定 project 的名称和配置文件：
export COMPOSE_PROJECT_NAME=TestVar export COMPOSE_FILE=~/projects/composecounter/docker-compose.yml 然后启动应用，显示的 project 名称都是我们在环境变量中指定的：
如果设置了环境变量的同时又指定了命令行选项，那么会应用命令行选项的设置：
docker-compose -p nickproject up -d 在 compose file 中引用环境变量 我们还可以在 compose file 中直接引用环境变量，比如下面的 demo：
version: &#39;3&#39; services: web: image: ${IMAGETAG} ports: - &#34;5000:5000&#34; redis: image: &#34;redis:alpine&#34; 我们通过环境变量 ${IMAGETAG} 指定了 web 的镜像，下面通过 export 的方式来为 compose 配置文件中的环境变量传值：
注意，如果对应的环境变量没有被设置，那么 compose 就会把它替换为一个空字符串：
碰到这种情况，我们可以在 compose 的配置文件中为该变量设置一个默认值："><meta itemprop="datePublished" content="2020-12-23T17:57:39+08:00" />
<meta itemprop="dateModified" content="2020-12-23T17:57:39+08:00" />
<meta itemprop="wordCount" content="355">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Docker Compose Config"/>
<meta name="twitter:description" content="在项目中，往往需要在 docker-compose.yml 文件中使用环境变量来控制不同的条件和使用场景。本文集中介绍 docker compose 引用环境变量的方式。
Compose CLI 与环境变量 Compose CLI(compose command-line 即 docker-compose 程序)能够识别名称为 COMPOSE_PROJECT_NAME 和 COMPOSE_FILE 等环境变量(具体支持的环境变量请参考这里)。比如我们可以通过这两个环境变量为 docker-compose 指定 project 的名称和配置文件：
export COMPOSE_PROJECT_NAME=TestVar export COMPOSE_FILE=~/projects/composecounter/docker-compose.yml 然后启动应用，显示的 project 名称都是我们在环境变量中指定的：
如果设置了环境变量的同时又指定了命令行选项，那么会应用命令行选项的设置：
docker-compose -p nickproject up -d 在 compose file 中引用环境变量 我们还可以在 compose file 中直接引用环境变量，比如下面的 demo：
version: &#39;3&#39; services: web: image: ${IMAGETAG} ports: - &#34;5000:5000&#34; redis: image: &#34;redis:alpine&#34; 我们通过环境变量 ${IMAGETAG} 指定了 web 的镜像，下面通过 export 的方式来为 compose 配置文件中的环境变量传值：
注意，如果对应的环境变量没有被设置，那么 compose 就会把它替换为一个空字符串：
碰到这种情况，我们可以在 compose 的配置文件中为该变量设置一个默认值："/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">My New Hugo Site</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">My New Hugo Site</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  <div class="post-content">
    <p>在项目中，往往需要在 docker-compose.yml 文件中使用环境变量来控制不同的条件和使用场景。本文集中介绍 docker compose 引用环境变量的方式。</p>
<h3 id="compose-cli-与环境变量">Compose CLI 与环境变量</h3>
<p>Compose CLI(compose command-line 即 docker-compose 程序)能够识别名称为 COMPOSE_PROJECT_NAME 和 COMPOSE_FILE 等环境变量(具体支持的环境变量请参考这里)。比如我们可以通过这两个环境变量为 docker-compose 指定 project 的名称和配置文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">export COMPOSE_PROJECT_NAME<span style="color:#f92672">=</span>TestVar
export COMPOSE_FILE<span style="color:#f92672">=</span>~/projects/composecounter/docker-compose.yml
</code></pre></div><p>然后启动应用，显示的 project 名称都是我们在环境变量中指定的：</p>
<p>如果设置了环境变量的同时又指定了命令行选项，那么会应用命令行选项的设置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker-compose -p nickproject up -d
</code></pre></div><p>在 compose file 中引用环境变量
我们还可以在 compose file 中直接引用环境变量，比如下面的 demo：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
  <span style="color:#f92672">services</span>:
    <span style="color:#f92672">web</span>:
      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">${IMAGETAG}</span>
      <span style="color:#f92672">ports</span>:
       - <span style="color:#e6db74">&#34;5000:5000&#34;</span>
    <span style="color:#f92672">redis</span>:
      <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;redis:alpine&#34;</span>
</code></pre></div><p>我们通过环境变量 ${IMAGETAG} 指定了 web 的镜像，下面通过 export 的方式来为 compose 配置文件中的环境变量传值：</p>
<p>注意，如果对应的环境变量没有被设置，那么 compose 就会把它替换为一个空字符串：</p>
<p>碰到这种情况，我们可以在 compose 的配置文件中为该变量设置一个默认值：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">web</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">${IMAGETAG:-defaultwebimage}</span>
    <span style="color:#f92672">ports</span>:
     - <span style="color:#e6db74">&#34;5000:5000&#34;</span>
  <span style="color:#f92672">redis</span>:
    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;redis:alpine&#34;</span>
</code></pre></div><p>这样，如果没有设置 IMAGETAG 变量，就会应用 defaultwebimage：</p>
<p>除了这种方式，我们还可以通过后面将介绍的 .env 文件来为环境变量设置默认值。</p>
<p>把环境变量传递给容器
先来看一下在 compose file 中如何为容器设置环境变量：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">web</span>:
  <span style="color:#f92672">environment</span>:
    <span style="color:#f92672">DEBUG</span>: <span style="color:#ae81ff">1</span>
</code></pre></div><p>compose file 中的 environment 节点用来为容器设置环境变量，上面的写法等同于：</p>
<p>$ docker run -e DEBUG=1
要把当前 shell 环境变量的值传递给容器的环境变量也很简单，去掉上面代码中的赋值部分就可以了：</p>
<pre><code>web:
  environment:
    DEBUG:
</code></pre><p>这种情况下，如果没有在当前的 shell 中导出环境变量 DEBUG，compose file 中会把它解释为 null：</p>
<p>在试试导出环境变量 DEBUG 的情况：</p>
<pre><code>$ export DEBUG=1
</code></pre><p>这才是我们设计的正确的使用场景！</p>
<p>使用文件为容器设置多个环境变量
如果觉得通过 environment 为容器设置环境变量不够过瘾，我们还可以像 docker -run 的 &ndash;env-file 参数一样通过文件为容器设置环境变量：</p>
<pre><code>web:
  env_file:
    - web-variables.env
</code></pre><p>注意，web-variables.env 文件的路径是相对于 docker-compose.yml 文件的相对路径。上面的代码效果与下面的代码相同：</p>
<pre><code>$ docker run --env-file=web-variables.env
</code></pre><p><code>web-variables.env</code> 文件中可以定义一个或多个环境变量：</p>
<pre><code># define web container env
APPNAME=helloworld
AUTHOR=Nick Li
VERSION=1.0
</code></pre><p>检查下结果：</p>
<p>原来 compose 把 env_file 的设置翻译成了 environment！</p>
<p>.env 文件
当我们在 docker-compose.yml 文件中引用了大量的环境变量时，对每个环境变量都设置默认值将是繁琐的，并且也会影响 docker-compose.yml 简洁程度。此时我们可以通过 .env 文件来为 docker-compose.yml 文件引用的所有环境变量设置默认值！
修改 docker-compose.yml 文件的内容如下：</p>
<pre><code>version: '3'
services:
  web:
    image: ${IMAGETAG}                 
    environment:
      APPNAME:
      AUTHOR:
      VERSION:
    ports:
     - &quot;5000:5000&quot;
  redis:
    image: &quot;redis:alpine&quot;
</code></pre><p>然后在相同的目录下创建 .env 文件，编辑其内容如下：</p>
<h1 id="define-env-var-default-value">define env var default value.</h1>
<p>IMAGETAG=defaultwebimage
APPNAME=default app name
AUTHOR=default author name
VERSION=default version is 1.0
检查下结果，此时所有的环境变量都显示为 .env 文件中定义的默认值：</p>
<p>配置不同场景下的环境变量
从前面的部分中我们可以看到，docker compose 提供了足够的灵活性来让我们设置 docker-compose.yml 文件中引用的环境变量，它们的优先级如下：</p>
<p>Compose file
Shell environment variables
Environment file
Dockerfile
Variable is not defined
首先，在 docker-compose.yml 文件中直接设置的值优先级是最高的。
然后是在当前 shell 中 export 的环境变量值。
接下来是在环境变量文件中定义的值。
再接下来是在 Dockerfile 中定义的值。
最后还没有找到相关的环境变量就认为该环境变量没有被定义。</p>
<p>根据上面的优先级定义，我们可以把不同场景下的环境变量定义在不同的 shell 脚本中并导出，然后在执行 docker-compose 命令前先执行 source 命令把 shell 脚本中定义的环境变量导出到当前的 shell 中。通过这样的方式可以减少维护环境变量的地方，下面的例子中我们分别在 docker-compose.yml 文件所在的目录创建 test.sh 和 prod.sh，test.sh 的内容如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span><span style="color:#75715e"># define env var default value.</span>
export IMAGETAG<span style="color:#f92672">=</span>web:v1
export APPNAME<span style="color:#f92672">=</span>HelloWorld
export AUTHOR<span style="color:#f92672">=</span>Nick Li
export VERSION<span style="color:#f92672">=</span>1.0
<span style="color:#75715e"># prod.sh 的内容如下：</span>

<span style="color:#75715e">#!/bin/bash</span>
<span style="color:#75715e"># define env var default value.</span>
export IMAGETAG<span style="color:#f92672">=</span>webpord:v1
export APPNAME<span style="color:#f92672">=</span>HelloWorldProd
export AUTHOR<span style="color:#f92672">=</span>Nick Li
export VERSION<span style="color:#f92672">=</span>1.0LTS
<span style="color:#75715e"># 在测试环境下，执行下面的命令：</span>

$ source test.sh
$ docker-compose config
</code></pre></div><p>此时 docker-compose.yml 中的环境变量应用的都是测试环境相关的设置。</p>
<p>而在生产环境下，执行下面的命令：</p>
<p>$ source prod.sh
$ docker-compose config</p>
<p>此时 docker-compose.yml 中的环境变量应用的都是生产环境相关的设置。</p>
<p>总结
docker compose 对环境变量的使用提供了非常丰富支持和灵活的使用方式。希望通过本文的总结可以帮助大家理清相关的用法，并能够以简洁的方式为不同的使用场景提供支持。</p>
<p>参考：
Compose CLI environment variables
Environment variables in Compose
Compose file variable substitution
Declare default environment variables in file</p>
<h3 id="参考资料">参考资料</h3>
<ul>
<li><a href="https://www.jb51.net/article/152297.htm">详解Docker Compose 中可用的环境变量问题</a></li>
<li><a href="https://www.cnblogs.com/sparkdev/p/9826520.html">Docker Compose 引用环境变量</a></li>
</ul>

  </div>
</article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://example.org/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
     - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>olOwOlo</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
