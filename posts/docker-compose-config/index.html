<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Docker Compose Config ::
        Strawbreey Notes
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="在项目中，往往需要在 docker-compose.yml 文件中使用环境变量来控制不同的条件和使用场景。本文集中介绍 docker compose 引用环境变量的方式。 Compose CLI 与环境变量 Compose CLI(compose command-line 即 docker-compose 程序)能够识"
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/docker-compose-config/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/styles/atom-one-dark.min.css">

<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/favicon.png" />

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>




<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Docker Compose Config"/>
<meta name="twitter:description" content="在项目中，往往需要在 docker-compose.yml 文件中使用环境变量来控制不同的条件和使用场景。本文集中介绍 docker compose 引用环境变量的方式。 Compose CLI 与环境变量 Compose CLI(compose command-line 即 docker-compose 程序)能够识"/>



<meta property="og:title" content="Docker Compose Config" />
<meta property="og:description" content="在项目中，往往需要在 docker-compose.yml 文件中使用环境变量来控制不同的条件和使用场景。本文集中介绍 docker compose 引用环境变量的方式。 Compose CLI 与环境变量 Compose CLI(compose command-line 即 docker-compose 程序)能够识" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/docker-compose-config/" />
<meta property="article:published_time" content="2020-12-23T17:57:39+08:00" />
<meta property="article:modified_time" content="2020-12-23T17:57:39+08:00" /><meta property="og:site_name" content="Strawbreey Notes" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    
    <span class="logo__text">
      Strawbreey Notes
    </span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/showcase">Showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Docker Compose Config</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-12-23
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 4 min read</span
        >
      
    </div>

    

    

    <div class="post-content">
      <p>在项目中，往往需要在 docker-compose.yml 文件中使用环境变量来控制不同的条件和使用场景。本文集中介绍 docker compose 引用环境变量的方式。</p>
<h3 id="compose-cli-与环境变量">Compose CLI 与环境变量</h3>
<p>Compose CLI(compose command-line 即 docker-compose 程序)能够识别名称为 COMPOSE_PROJECT_NAME 和 COMPOSE_FILE 等环境变量(具体支持的环境变量请参考这里)。比如我们可以通过这两个环境变量为 docker-compose 指定 project 的名称和配置文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">export COMPOSE_PROJECT_NAME<span style="color:#f92672">=</span>TestVar
export COMPOSE_FILE<span style="color:#f92672">=</span>~/projects/composecounter/docker-compose.yml
</code></pre></div><p>然后启动应用，显示的 project 名称都是我们在环境变量中指定的：</p>
<p>如果设置了环境变量的同时又指定了命令行选项，那么会应用命令行选项的设置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker-compose -p nickproject up -d
</code></pre></div><p>在 compose file 中引用环境变量
我们还可以在 compose file 中直接引用环境变量，比如下面的 demo：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
  services:
    web:
      <span style="color:#66d9ef">image</span>: ${IMAGETAG}
      ports:
       - <span style="color:#e6db74">&#34;5000:5000&#34;</span>
    redis:
      <span style="color:#66d9ef">image</span>: <span style="color:#e6db74">&#34;redis:alpine&#34;</span>
</code></pre></div><p>我们通过环境变量 ${IMAGETAG} 指定了 web 的镜像，下面通过 export 的方式来为 compose 配置文件中的环境变量传值：</p>
<p>注意，如果对应的环境变量没有被设置，那么 compose 就会把它替换为一个空字符串：</p>
<p>碰到这种情况，我们可以在 compose 的配置文件中为该变量设置一个默认值：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
services:
  web:
    <span style="color:#66d9ef">image</span>: ${IMAGETAG:-defaultwebimage}
    ports:
     - <span style="color:#e6db74">&#34;5000:5000&#34;</span>
  redis:
    <span style="color:#66d9ef">image</span>: <span style="color:#e6db74">&#34;redis:alpine&#34;</span>
</code></pre></div><p>这样，如果没有设置 IMAGETAG 变量，就会应用 defaultwebimage：</p>
<p>除了这种方式，我们还可以通过后面将介绍的 .env 文件来为环境变量设置默认值。</p>
<p>把环境变量传递给容器
先来看一下在 compose file 中如何为容器设置环境变量：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">web:
  environment:
    <span style="color:#66d9ef">DEBUG</span>: <span style="color:#ae81ff">1</span>
</code></pre></div><p>compose file 中的 environment 节点用来为容器设置环境变量，上面的写法等同于：</p>
<p>$ docker run -e DEBUG=1
要把当前 shell 环境变量的值传递给容器的环境变量也很简单，去掉上面代码中的赋值部分就可以了：</p>
<pre><code>web:
  environment:
    DEBUG:
</code></pre><p>这种情况下，如果没有在当前的 shell 中导出环境变量 DEBUG，compose file 中会把它解释为 null：</p>
<p>在试试导出环境变量 DEBUG 的情况：</p>
<pre><code>$ export DEBUG=1
</code></pre><p>这才是我们设计的正确的使用场景！</p>
<p>使用文件为容器设置多个环境变量
如果觉得通过 environment 为容器设置环境变量不够过瘾，我们还可以像 docker -run 的 &ndash;env-file 参数一样通过文件为容器设置环境变量：</p>
<pre><code>web:
  env_file:
    - web-variables.env
</code></pre><p>注意，web-variables.env 文件的路径是相对于 docker-compose.yml 文件的相对路径。上面的代码效果与下面的代码相同：</p>
<pre><code>$ docker run --env-file=web-variables.env
</code></pre><p><code>web-variables.env</code> 文件中可以定义一个或多个环境变量：</p>
<pre><code># define web container env
APPNAME=helloworld
AUTHOR=Nick Li
VERSION=1.0
</code></pre><p>检查下结果：</p>
<p>原来 compose 把 env_file 的设置翻译成了 environment！</p>
<p>.env 文件
当我们在 docker-compose.yml 文件中引用了大量的环境变量时，对每个环境变量都设置默认值将是繁琐的，并且也会影响 docker-compose.yml 简洁程度。此时我们可以通过 .env 文件来为 docker-compose.yml 文件引用的所有环境变量设置默认值！
修改 docker-compose.yml 文件的内容如下：</p>
<pre><code>version: '3'
services:
  web:
    image: ${IMAGETAG}                 
    environment:
      APPNAME:
      AUTHOR:
      VERSION:
    ports:
     - &quot;5000:5000&quot;
  redis:
    image: &quot;redis:alpine&quot;
</code></pre><p>然后在相同的目录下创建 .env 文件，编辑其内容如下：</p>
<h1 id="define-env-var-default-value">define env var default value.</h1>
<p>IMAGETAG=defaultwebimage
APPNAME=default app name
AUTHOR=default author name
VERSION=default version is 1.0
检查下结果，此时所有的环境变量都显示为 .env 文件中定义的默认值：</p>
<p>配置不同场景下的环境变量
从前面的部分中我们可以看到，docker compose 提供了足够的灵活性来让我们设置 docker-compose.yml 文件中引用的环境变量，它们的优先级如下：</p>
<p>Compose file
Shell environment variables
Environment file
Dockerfile
Variable is not defined
首先，在 docker-compose.yml 文件中直接设置的值优先级是最高的。
然后是在当前 shell 中 export 的环境变量值。
接下来是在环境变量文件中定义的值。
再接下来是在 Dockerfile 中定义的值。
最后还没有找到相关的环境变量就认为该环境变量没有被定义。</p>
<p>根据上面的优先级定义，我们可以把不同场景下的环境变量定义在不同的 shell 脚本中并导出，然后在执行 docker-compose 命令前先执行 source 命令把 shell 脚本中定义的环境变量导出到当前的 shell 中。通过这样的方式可以减少维护环境变量的地方，下面的例子中我们分别在 docker-compose.yml 文件所在的目录创建 test.sh 和 prod.sh，test.sh 的内容如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span><span style="color:#75715e"># define env var default value.</span>
export IMAGETAG<span style="color:#f92672">=</span>web:v1
export APPNAME<span style="color:#f92672">=</span>HelloWorld
export AUTHOR<span style="color:#f92672">=</span>Nick Li
export VERSION<span style="color:#f92672">=</span>1.0
<span style="color:#75715e"># prod.sh 的内容如下：</span>

<span style="color:#75715e">#!/bin/bash</span>
<span style="color:#75715e"># define env var default value.</span>
export IMAGETAG<span style="color:#f92672">=</span>webpord:v1
export APPNAME<span style="color:#f92672">=</span>HelloWorldProd
export AUTHOR<span style="color:#f92672">=</span>Nick Li
export VERSION<span style="color:#f92672">=</span>1.0LTS
<span style="color:#75715e"># 在测试环境下，执行下面的命令：</span>

$ source test.sh
$ docker-compose config
</code></pre></div><p>此时 docker-compose.yml 中的环境变量应用的都是测试环境相关的设置。</p>
<p>而在生产环境下，执行下面的命令：</p>
<p>$ source prod.sh
$ docker-compose config</p>
<p>此时 docker-compose.yml 中的环境变量应用的都是生产环境相关的设置。</p>
<p>总结
docker compose 对环境变量的使用提供了非常丰富支持和灵活的使用方式。希望通过本文的总结可以帮助大家理清相关的用法，并能够以简洁的方式为不同的使用场景提供支持。</p>
<p>参考：
Compose CLI environment variables
Environment variables in Compose
Compose file variable substitution
Declare default environment variables in file</p>
<h3 id="参考资料">参考资料</h3>
<ul>
<li><a href="https://www.jb51.net/article/152297.htm">详解Docker Compose 中可用的环境变量问题</a></li>
<li><a href="https://www.cnblogs.com/sparkdev/p/9826520.html">Docker Compose 引用环境变量</a></li>
</ul>

    </div>
    
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/posts/eslint/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Eslint</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/posts/docker-compose-network-mode/">
                  <span class="button__text">Docker Compose Network Mode</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

<div id="gitalk-container"></div>
<script>
  const gitalk = new Gitalk({
    clientID: '4655ac5540fffb80a545',
    clientSecret: '714d4e40a23897dc8e329b9d1ec37a1ffe8fd5d3',
    repo: 'https://github.com/strawbreey/notes',      
    owner: 'strawbreey',
    admin: ['strawbreey'],
    id: location.pathname,      
    distractionFreeMode: false  
  })

  gitalk.render('gitalk-container')
</script>
      
    
  </div>

  <aside class="aside table-of-contents">
    
    <section class="toc">
        <h3>title</h3>
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#compose-cli-与环境变量">Compose CLI 与环境变量</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#参考资料">参考资料</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </section>

    


<section class="related">
  <h3>See Also</h3>
  <ul>
    
    <li><a href="/posts/docker-compose-network-mode/">Docker Compose Network Mode</a></li>
    
    <li><a href="/posts/yii-data-cache/">Yii Data Cache</a></li>
    
    <li><a href="/posts/linux-install-software/">Linux Install Software</a></li>
    
    <li><a href="/posts/http-ip/">Http Ip</a></li>
    
    <li><a href="/posts/k8s-tutorial/">K8s Tutorial</a></li>
    
  </ul>
  
</section>
  </aside>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">Copyright©2019-2020 Strawbreey. All Rights Reserved</div>
      
  </div>
</footer>

<script src="/assets/main.js"></script>





<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/highlight.min.js"></script>




      
    </div>

    
  </body>
</html>
