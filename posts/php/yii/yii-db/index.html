<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Yii Db - My New Hugo Site</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="olOwOlo" /><meta name="description" content="Yii 包含了一个建立在 PHP PDO 之上的数据访问层 (DAO： Database Access Objects)。DAO为不同的数据库提供了一套统一的API。 其中 ActiveRecord 提供了数据库与模型(MVC 中的 M,Model) 的交互，QueryBuilder 用于创建动态的查询语句。 DAO提供了简单高效的SQL查询，可以用在与数据库交互的各个地方.
使用 Yii DAO 时，你主要需要处理纯 SQL 语句和 PHP 数组。因此，这是访问数据库最高效的方法。 然而，因为不同数据库之间的 SQL 语法往往是不同的， 使用 Yii DAO 也意味着你必须花些额外的工夫来创建一个”数据库无关“的应用。
连接数据库 // 连接数据库 $db = new yii\db\Connection([ &amp;#39;dsn&amp;#39; =&amp;gt; &amp;#39;mysql:host=localhost;dbname=example&amp;#39;, &amp;#39;username&amp;#39; =&amp;gt; &amp;#39;root&amp;#39;, &amp;#39;password&amp;#39; =&amp;gt; &amp;#39;&amp;#39;, &amp;#39;charset&amp;#39; =&amp;gt; &amp;#39;utf8&amp;#39;, ]); return [ &amp;#39;components&amp;#39; =&amp;gt; [ &amp;#39;db&amp;#39; =&amp;gt; [ &amp;#39;class&amp;#39; =&amp;gt; &amp;#39;yii\db\Connection&amp;#39;, &amp;#39;dsn&amp;#39; =&amp;gt; &amp;#39;mysql:host=localhost;dbname=example&amp;#39;, &amp;#39;username&amp;#39; =&amp;gt; &amp;#39;root&amp;#39;, &amp;#39;password&amp;#39; =&amp;gt; &amp;#39;&amp;#39;, &amp;#39;charset&amp;#39; =&amp;gt; &amp;#39;utf8&amp;#39;, ], ], ]; SQL 查询 // 返回多行." />






<meta name="generator" content="Hugo 0.86.0-DEV with theme even" />


<link rel="canonical" href="https://example.org/posts/php/yii/yii-db/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">



<meta property="og:title" content="Yii Db" />
<meta property="og:description" content="Yii 包含了一个建立在 PHP PDO 之上的数据访问层 (DAO： Database Access Objects)。DAO为不同的数据库提供了一套统一的API。 其中 ActiveRecord 提供了数据库与模型(MVC 中的 M,Model) 的交互，QueryBuilder 用于创建动态的查询语句。 DAO提供了简单高效的SQL查询，可以用在与数据库交互的各个地方.
使用 Yii DAO 时，你主要需要处理纯 SQL 语句和 PHP 数组。因此，这是访问数据库最高效的方法。 然而，因为不同数据库之间的 SQL 语法往往是不同的， 使用 Yii DAO 也意味着你必须花些额外的工夫来创建一个”数据库无关“的应用。
连接数据库 // 连接数据库 $db = new yii\db\Connection([ &#39;dsn&#39; =&gt; &#39;mysql:host=localhost;dbname=example&#39;, &#39;username&#39; =&gt; &#39;root&#39;, &#39;password&#39; =&gt; &#39;&#39;, &#39;charset&#39; =&gt; &#39;utf8&#39;, ]); return [ &#39;components&#39; =&gt; [ &#39;db&#39; =&gt; [ &#39;class&#39; =&gt; &#39;yii\db\Connection&#39;, &#39;dsn&#39; =&gt; &#39;mysql:host=localhost;dbname=example&#39;, &#39;username&#39; =&gt; &#39;root&#39;, &#39;password&#39; =&gt; &#39;&#39;, &#39;charset&#39; =&gt; &#39;utf8&#39;, ], ], ]; SQL 查询 // 返回多行." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.org/posts/php/yii/yii-db/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-11T19:09:39+08:00" />
<meta property="article:modified_time" content="2020-11-11T19:09:39+08:00" />

<meta itemprop="name" content="Yii Db">
<meta itemprop="description" content="Yii 包含了一个建立在 PHP PDO 之上的数据访问层 (DAO： Database Access Objects)。DAO为不同的数据库提供了一套统一的API。 其中 ActiveRecord 提供了数据库与模型(MVC 中的 M,Model) 的交互，QueryBuilder 用于创建动态的查询语句。 DAO提供了简单高效的SQL查询，可以用在与数据库交互的各个地方.
使用 Yii DAO 时，你主要需要处理纯 SQL 语句和 PHP 数组。因此，这是访问数据库最高效的方法。 然而，因为不同数据库之间的 SQL 语法往往是不同的， 使用 Yii DAO 也意味着你必须花些额外的工夫来创建一个”数据库无关“的应用。
连接数据库 // 连接数据库 $db = new yii\db\Connection([ &#39;dsn&#39; =&gt; &#39;mysql:host=localhost;dbname=example&#39;, &#39;username&#39; =&gt; &#39;root&#39;, &#39;password&#39; =&gt; &#39;&#39;, &#39;charset&#39; =&gt; &#39;utf8&#39;, ]); return [ &#39;components&#39; =&gt; [ &#39;db&#39; =&gt; [ &#39;class&#39; =&gt; &#39;yii\db\Connection&#39;, &#39;dsn&#39; =&gt; &#39;mysql:host=localhost;dbname=example&#39;, &#39;username&#39; =&gt; &#39;root&#39;, &#39;password&#39; =&gt; &#39;&#39;, &#39;charset&#39; =&gt; &#39;utf8&#39;, ], ], ]; SQL 查询 // 返回多行."><meta itemprop="datePublished" content="2020-11-11T19:09:39+08:00" />
<meta itemprop="dateModified" content="2020-11-11T19:09:39+08:00" />
<meta itemprop="wordCount" content="632">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Yii Db"/>
<meta name="twitter:description" content="Yii 包含了一个建立在 PHP PDO 之上的数据访问层 (DAO： Database Access Objects)。DAO为不同的数据库提供了一套统一的API。 其中 ActiveRecord 提供了数据库与模型(MVC 中的 M,Model) 的交互，QueryBuilder 用于创建动态的查询语句。 DAO提供了简单高效的SQL查询，可以用在与数据库交互的各个地方.
使用 Yii DAO 时，你主要需要处理纯 SQL 语句和 PHP 数组。因此，这是访问数据库最高效的方法。 然而，因为不同数据库之间的 SQL 语法往往是不同的， 使用 Yii DAO 也意味着你必须花些额外的工夫来创建一个”数据库无关“的应用。
连接数据库 // 连接数据库 $db = new yii\db\Connection([ &#39;dsn&#39; =&gt; &#39;mysql:host=localhost;dbname=example&#39;, &#39;username&#39; =&gt; &#39;root&#39;, &#39;password&#39; =&gt; &#39;&#39;, &#39;charset&#39; =&gt; &#39;utf8&#39;, ]); return [ &#39;components&#39; =&gt; [ &#39;db&#39; =&gt; [ &#39;class&#39; =&gt; &#39;yii\db\Connection&#39;, &#39;dsn&#39; =&gt; &#39;mysql:host=localhost;dbname=example&#39;, &#39;username&#39; =&gt; &#39;root&#39;, &#39;password&#39; =&gt; &#39;&#39;, &#39;charset&#39; =&gt; &#39;utf8&#39;, ], ], ]; SQL 查询 // 返回多行."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">My New Hugo Site</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">My New Hugo Site</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  <div class="post-content">
    <p>Yii 包含了一个建立在 PHP PDO 之上的数据访问层 (DAO： Database Access Objects)。DAO为不同的数据库提供了一套统一的API。 其中 ActiveRecord 提供了数据库与模型(MVC 中的 M,Model) 的交互，QueryBuilder 用于创建动态的查询语句。 DAO提供了简单高效的SQL查询，可以用在与数据库交互的各个地方.</p>
<p>使用 Yii DAO 时，你主要需要处理纯 SQL 语句和 PHP 数组。因此，这是访问数据库最高效的方法。 然而，因为不同数据库之间的 SQL 语法往往是不同的， 使用 Yii DAO 也意味着你必须花些额外的工夫来创建一个”数据库无关“的应用。</p>
<h3 id="连接数据库">连接数据库</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">// 连接数据库
</span><span style="color:#75715e"></span>$db <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">yii\db\Connection</span>([
    <span style="color:#e6db74">&#39;dsn&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;mysql:host=localhost;dbname=example&#39;</span>,
    <span style="color:#e6db74">&#39;username&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;root&#39;</span>,
    <span style="color:#e6db74">&#39;password&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;&#39;</span>,
    <span style="color:#e6db74">&#39;charset&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;utf8&#39;</span>,
]);

<span style="color:#66d9ef">return</span> [
    <span style="color:#e6db74">&#39;components&#39;</span> <span style="color:#f92672">=&gt;</span> [
        <span style="color:#e6db74">&#39;db&#39;</span> <span style="color:#f92672">=&gt;</span> [
            <span style="color:#e6db74">&#39;class&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;yii\db\Connection&#39;</span>,
            <span style="color:#e6db74">&#39;dsn&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;mysql:host=localhost;dbname=example&#39;</span>,
            <span style="color:#e6db74">&#39;username&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;root&#39;</span>,
            <span style="color:#e6db74">&#39;password&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;&#39;</span>,
            <span style="color:#e6db74">&#39;charset&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;utf8&#39;</span>,
        ],
    ],
];
</code></pre></div><h3 id="sql-查询">SQL 查询</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">// 返回多行. 每行都是列名和值的关联数组.
</span><span style="color:#75715e">// 如果该查询没有结果则返回空数组
</span><span style="color:#75715e"></span>$posts <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;SELECT * FROM post&#39;</span>)
            <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryAll</span>();

<span style="color:#75715e">// 返回一行 (第一行)
</span><span style="color:#75715e">// 如果该查询没有结果则返回 false
</span><span style="color:#75715e"></span>$post <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;SELECT * FROM post WHERE id=1&#39;</span>)
           <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryOne</span>();

<span style="color:#75715e">// 返回一列 (第一列)
</span><span style="color:#75715e">// 如果该查询没有结果则返回空数组
</span><span style="color:#75715e"></span>$titles <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;SELECT title FROM post&#39;</span>)
             <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryColumn</span>();

<span style="color:#75715e">// 返回一个标量值
</span><span style="color:#75715e">// 如果该查询没有结果则返回 false
</span><span style="color:#75715e"></span>$count <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;SELECT COUNT(*) FROM post&#39;</span>)
             <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryScalar</span>();
</code></pre></div><p>当使用带参数的 SQL 来创建数据库命令时， 你几乎总是应该使用绑定参数的方法来防止 SQL 注入攻击</p>
<p>bindValue()：绑定一个参数值
bindValues()：在一次调用中绑定多个参数值
bindParam()：与 bindValue() 相似，但是也支持绑定参数引用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$post <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;SELECT * FROM post WHERE id=:id AND status=:status&#39;</span>)
           <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bindValue</span>(<span style="color:#e6db74">&#39;:id&#39;</span>, $_GET[<span style="color:#e6db74">&#39;id&#39;</span>])
           <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bindValue</span>(<span style="color:#e6db74">&#39;:status&#39;</span>, <span style="color:#ae81ff">1</span>)
           <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryOne</span>();

$params <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;:id&#39;</span> <span style="color:#f92672">=&gt;</span> $_GET[<span style="color:#e6db74">&#39;id&#39;</span>], <span style="color:#e6db74">&#39;:status&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>];

$post <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;SELECT * FROM post WHERE id=:id AND status=:status&#39;</span>)
           <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bindValues</span>($params)
           <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryOne</span>();
           
$post <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;SELECT * FROM post WHERE id=:id AND status=:status&#39;</span>, $params)
           <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryOne</span>();
</code></pre></div><p>绑定参数是通过 预处理语句 实现的。 除了防止 SQL 注入攻击，它也可以通过一次预处理 SQL 语句， 使用不同参数多次执行，来提升性能。例如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$command <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;SELECT * FROM post WHERE id=:id&#39;</span>);

$post1 <span style="color:#f92672">=</span> $command<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bindValue</span>(<span style="color:#e6db74">&#39;:id&#39;</span>, <span style="color:#ae81ff">1</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryOne</span>();
$post2 <span style="color:#f92672">=</span> $command<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bindValue</span>(<span style="color:#e6db74">&#39;:id&#39;</span>, <span style="color:#ae81ff">2</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryOne</span>();
</code></pre></div><p>因为 bindParam() 支持通过引用来绑定参数， 上述代码也可以像下面这样写：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$command <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;SELECT * FROM post WHERE id=:id&#39;</span>)
              <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bindParam</span>(<span style="color:#e6db74">&#39;:id&#39;</span>, $id);

$id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
$post1 <span style="color:#f92672">=</span> $command<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryOne</span>();

$id <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
$post2 <span style="color:#f92672">=</span> $command<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">queryOne</span>();
</code></pre></div><p>执行非查询语句</p>
<p>上面部分中介绍的 queryXyz() 方法都处理的是从数据库返回数据的查询语句。对于那些不取回数据的语句， 你应该调用的是 yii\db\Command::execute() 方法。例如，</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>(<span style="color:#e6db74">&#39;UPDATE post SET status=1 WHERE id=1&#39;</span>)
   <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
</code></pre></div><p>对于 INSERT, UPDATE 和 DELETE 语句，不再需要写纯SQL语句了， 你可以直接调用 insert()、update()、delete()， 来构建相应的 SQL 语句。这些方法将正确地引用表和列名称以及绑定参数值。例如,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">insert</span>(<span style="color:#e6db74">&#39;user&#39;</span>, [
    <span style="color:#e6db74">&#39;name&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Sam&#39;</span>,
    <span style="color:#e6db74">&#39;age&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">30</span>,
])<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();

<span style="color:#75715e">// UPDATE (table name, column values, condition)
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">update</span>(<span style="color:#e6db74">&#39;user&#39;</span>, [<span style="color:#e6db74">&#39;status&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#39;age &gt; 30&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();

<span style="color:#75715e">// DELETE (table name, condition)
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">delete</span>(<span style="color:#e6db74">&#39;user&#39;</span>, <span style="color:#e6db74">&#39;status = 0&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
</code></pre></div><p>你也可以调用 batchInsert() 来一次插入多行， 这比一次插入一行要高效得多：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
<span style="color:#75715e">// table name, column names, column values
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">batchInsert</span>(<span style="color:#e6db74">&#39;user&#39;</span>, [<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;age&#39;</span>], [
    [<span style="color:#e6db74">&#39;Tom&#39;</span>, <span style="color:#ae81ff">30</span>],
    [<span style="color:#e6db74">&#39;Jane&#39;</span>, <span style="color:#ae81ff">20</span>],
    [<span style="color:#e6db74">&#39;Linda&#39;</span>, <span style="color:#ae81ff">25</span>],
])<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
</code></pre></div><p>另一个有用的方法是 upsert()。Upsert 是一种原子操作，如果它们不存在（匹配唯一约束），则将行插入到数据库表中， 或者在它们执行时更新它们：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upsert</span>(<span style="color:#e6db74">&#39;pages&#39;</span>, [
    <span style="color:#e6db74">&#39;name&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Front page&#39;</span>,
    <span style="color:#e6db74">&#39;url&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;http://example.com/&#39;</span>, <span style="color:#75715e">// url is unique
</span><span style="color:#75715e"></span>    <span style="color:#e6db74">&#39;visits&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>,
], [
    <span style="color:#e6db74">&#39;visits&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">\yii\db\Expression</span>(<span style="color:#e6db74">&#39;visits + 1&#39;</span>),
], $params)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();

</code></pre></div><p>执行事务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">transaction</span>(<span style="color:#66d9ef">function</span>($db) {
    $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>($sql1)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
    $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>($sql2)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
    <span style="color:#75715e">// ... executing other SQL statements ...
</span><span style="color:#75715e"></span>});

<span style="color:#75715e">// 上述代码等价于下面的代码，但是下面的代码给予了你对于错误处理代码的更多掌控：
</span><span style="color:#75715e"></span>
$db <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span>;
$transaction <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">beginTransaction</span>();
<span style="color:#66d9ef">try</span> {
    $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>($sql1)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
    $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>($sql2)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
    <span style="color:#75715e">// ... executing other SQL statements ...
</span><span style="color:#75715e"></span>    
    $transaction<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">commit</span>();
} <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">\Exception</span> $e) {
    $transaction<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rollBack</span>();
    <span style="color:#66d9ef">throw</span> $e;
} <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">\Throwable</span> $e) {
    $transaction<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rollBack</span>();
    <span style="color:#66d9ef">throw</span> $e;
}
</code></pre></div><p>嵌套事务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">transaction</span>(<span style="color:#66d9ef">function</span> ($db) {
    <span style="color:#75715e">// outer transaction
</span><span style="color:#75715e"></span>    
    $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">transaction</span>(<span style="color:#66d9ef">function</span> ($db) {
        <span style="color:#75715e">// inner transaction
</span><span style="color:#75715e"></span>    });
});

<span style="color:#75715e">// 上述代码等价于下面的代码，但是下面的代码给予了你对于错误处理代码的更多掌控：
</span><span style="color:#75715e"></span>

$db <span style="color:#f92672">=</span> <span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span>;
$outerTransaction <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">beginTransaction</span>();
<span style="color:#66d9ef">try</span> {
    $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>($sql1)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();

    $innerTransaction <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">beginTransaction</span>();
    <span style="color:#66d9ef">try</span> {
        $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>($sql2)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
        $innerTransaction<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">commit</span>();
    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">\Exception</span> $e) {
        $innerTransaction<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rollBack</span>();
        <span style="color:#66d9ef">throw</span> $e;
    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">\Throwable</span> $e) {
        $innerTransaction<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rollBack</span>();
        <span style="color:#66d9ef">throw</span> $e;
    }

    $outerTransaction<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">commit</span>();
} <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">\Exception</span> $e) {
    $outerTransaction<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rollBack</span>();
    <span style="color:#66d9ef">throw</span> $e;
} <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">\Throwable</span> $e) {
    $outerTransaction<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rollBack</span>();
    <span style="color:#66d9ef">throw</span> $e;
}

</code></pre></div><p>操纵数据库模式</p>
<p>Yii DAO 提供了一套完整的方法来让你操纵数据库模式， 如创建表、从表中删除一列，等等。这些方法罗列如下：</p>
<ul>
<li>createTable()：创建一张表</li>
<li>renameTable()：重命名一张表</li>
<li>dropTable()：删除一张表</li>
<li>truncateTable()：删除一张表中的所有行</li>
<li>addColumn()：增加一列</li>
<li>renameColumn()：重命名一列</li>
<li>dropColumn()：删除一列</li>
<li>alterColumn()：修改一列</li>
<li>addPrimaryKey()：增加主键</li>
<li>dropPrimaryKey()：删除主键</li>
<li>addForeignKey()：增加一个外键</li>
<li>dropForeignKey()：删除一个外键</li>
<li>createIndex()：增加一个索引</li>
<li>dropIndex()：删除一个索引
这些方法可以如下地使用：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">Yii</span><span style="color:#f92672">::</span>$app<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createCommand</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">createTable</span>(<span style="color:#e6db74">&#39;post&#39;</span>, [
    <span style="color:#e6db74">&#39;id&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;pk&#39;</span>,
    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;string&#39;</span>,
    <span style="color:#e6db74">&#39;text&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;text&#39;</span>,
]);
</code></pre></div><p>查询构建器</p>
<p>查询构建器建立在 Database Access Objects 基础之上，可让你创建 程序化的、DBMS无关的SQL语句。相比于原生的SQL语句，查询构建器可以帮你 写出可读性更强的SQL相关的代码，并生成安全性更强的SQL语句。</p>
<p>使用查询构建器通常包含以下两个步骤：</p>
<ul>
<li>创建一个 yii\db\Query 对象来代表一条 SELECT SQL 语句的不同子句（例如 SELECT, FROM）。</li>
<li>执行 yii\db\Query 的一个查询方法（例如：all()）从数据库当中检索数据。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$rows <span style="color:#f92672">=</span> (<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">\yii\db\Query</span>())
    <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>([<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>])
    <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>(<span style="color:#e6db74">&#39;user&#39;</span>)
    <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">where</span>([<span style="color:#e6db74">&#39;last_name&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Smith&#39;</span>])
    <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">limit</span>(<span style="color:#ae81ff">10</span>)
    <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">all</span>();
</code></pre></div><p>=&gt;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>email<span style="color:#f92672">`</span> 
<span style="color:#66d9ef">FROM</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">user</span><span style="color:#f92672">`</span>
<span style="color:#66d9ef">WHERE</span> <span style="color:#f92672">`</span>last_name<span style="color:#f92672">`</span> <span style="color:#f92672">=</span> :last_name
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">10</span>

</code></pre></div><p>创建查询</p>
<p>select()</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>([<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>]);
<span style="color:#75715e">// 等同于：
</span><span style="color:#75715e"></span>$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>(<span style="color:#e6db74">&#39;id, email&#39;</span>);

$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>([<span style="color:#e6db74">&#39;user.id AS user_id&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>]);
<span style="color:#75715e">// 等同于：
</span><span style="color:#75715e"></span>$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>(<span style="color:#e6db74">&#39;user.id AS user_id, email&#39;</span>);

$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>([<span style="color:#e6db74">&#39;user_id&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;user.id&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>]);

$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>([<span style="color:#e6db74">&#34;CONCAT(first_name, &#39; &#39;, last_name) AS full_name&#34;</span>, <span style="color:#e6db74">&#39;email&#39;</span>]); 

$subQuery <span style="color:#f92672">=</span> (<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Query</span>())<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>(<span style="color:#e6db74">&#39;COUNT(*)&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>(<span style="color:#e6db74">&#39;user&#39;</span>);

<span style="color:#75715e">// SELECT `id`, (SELECT COUNT(*) FROM `user`) AS `count` FROM `post`
</span><span style="color:#75715e"></span>$query <span style="color:#f92672">=</span> (<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Query</span>())<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>([<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;count&#39;</span> <span style="color:#f92672">=&gt;</span> $subQuery])<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>(<span style="color:#e6db74">&#39;post&#39;</span>);

$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>(<span style="color:#e6db74">&#39;user_id&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">distinct</span>();

$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>([<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;username&#39;</span>])
    <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addSelect</span>([<span style="color:#e6db74">&#39;email&#39;</span>]);
</code></pre></div><p>from()</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>(<span style="color:#e6db74">&#39;user&#39;</span>);

$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>([<span style="color:#e6db74">&#39;public.user u&#39;</span>, <span style="color:#e6db74">&#39;public.post p&#39;</span>]);
<span style="color:#75715e">// 等同于：
</span><span style="color:#75715e"></span>$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>(<span style="color:#e6db74">&#39;public.user u, public.post p&#39;</span>);

$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>([<span style="color:#e6db74">&#39;u&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;public.user&#39;</span>, <span style="color:#e6db74">&#39;p&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;public.post&#39;</span>]);

$subQuery <span style="color:#f92672">=</span> (<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Query</span>())<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">select</span>(<span style="color:#e6db74">&#39;id&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>(<span style="color:#e6db74">&#39;user&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">where</span>(<span style="color:#e6db74">&#39;status=1&#39;</span>);
<span style="color:#75715e">// SELECT * FROM (SELECT `id` FROM `user` WHERE status=1) u 
</span><span style="color:#75715e"></span>$query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>([<span style="color:#e6db74">&#39;u&#39;</span> <span style="color:#f92672">=&gt;</span> $subQuery]);

</code></pre></div>
  </div>
</article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://example.org/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
     - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>olOwOlo</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
